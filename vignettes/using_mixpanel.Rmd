---
title: "Using mixpanel"
author:
- name: Martin Morgan
  affiliation: Roswell Park Comprehensive Cancer Center
  email: mtmorgan.bioc@gmail.com
package: mixpanel
output:
  BiocStyle::html_document
vignette: |
  %\VignetteIndexEntry{Using mixpanel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Installation

Install the package from GitHub, e.g.,

```{r, eval = FALSE}
BiocManager::install("mtmorgan/mixpanel")
```

Load the package and [dplyr][]

```{r, message = FALSE}
library(mixpanel)
library(dplyr)
options(dplyr.summarise.inform = FALSE)
```

[dplyr]: https://cloud.r-project.org/package=dplyr

# Configuration and localization

Use `retrieve()` to configure Google Drive access. Once authorized,
`retrieve()` finds and localizes all `.csv` files in the MixPanel
Google Drive folder. Files already cached are not downloaded a second
time.

```{r, message = FALSE}
tbl <- retrieve()
```

# Use

Use `read()` to concatenate several CSV files into a single
tibble. Usually the CSV files summarize the same facet but in
different months.

Use `hash()` to obscure (not cryptographically secure or recoverable
in a separate R session) potentially sensitive information such as
workspace or workflow names. `unhash()` can be used to recover
original values, but only in the same session as the `hash()` call
that generate the keys.

The following file titles are available for summary.

```{r}
distinct(tbl, title)
```

## Summary uses

Application (Galaxy, RStudio, Notebook) launches, per month.

```{r}
filter(tbl, title == "Application Launches") |>
    read() |>
    group_by(Event, Month) |>
    summarize(n = sum(DateRangeCount))
```

Application unique users, per month.

```{r}
filter(tbl, title == "Application Users") |>
    read() |>
    group_by(Event, Month) |>
    summarize(n = sum(DateRangeCount))
```

Workspace use, cummulative.

```{r}
filter(tbl, title == "Cloned Workspaces") |>
    read() |>
	mutate(
	    fromWorkspaceName = hash(fromWorkspaceName, except = "^Bioconductor")
	) |>
    group_by(fromWorkspaceName) |>
    summarize(n = sum(DateRangeCount)) |>
    filter(n > 1L) |>
    arrange(desc(n))
```

Workflow import, launch, and re-run, per month.

```{r}
filter(tbl, title == "Workflow Actions") |>
    read() |>
    group_by(Event, Month) |>
    summarize(n = sum(DateRangeCount))
```

Workflow use, cummulative.

```{r}
filter(tbl, title == "What workflows have been launched") |>
    read() |>
    mutate(methodPath = hash(methodPath)) |>
    group_by(methodPath) |>
    summarize(n = sum(DateRangeCount)) |>
    arrange(desc(n))
```

Workflow source (e.g., dockstore).

```{r}
filter(tbl, title == "Workflow Import Source") |>
    read() |>
    group_by(source, Month) |>
    summarize(n = sum(DateRangeCount))
```

## Retention

The `retention_report` summarizes how many users from one particular
day (or the monthly `$average`) are seen again in 1, 2, ... months.

```{r}
filter(tbl, title ==  "retention_report") |>
    read() |>
    filter(Date == "$average")
```

_Bioconductor_ PopUp workshops where held on the following dates:

```{r}
dates <- as.character(as.Date("2021-04-26") + (0:6) * 7)[-6]
filter(tbl, title ==  "retention_report") |>
    read() |>
    filter(Date %in% dates)
```


# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```
